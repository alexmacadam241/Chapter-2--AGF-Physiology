---
title: "Physiology- A. hyacinthus juvenile size"
author: "Alex Macadam"
date: "2023-10-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load the necessary libraries
```{r libraries, results='markdown', eval=TRUE, message=FALSE, warning=FALSE}
library(car)       #for regression diagnostics
library(broom)     #for tidy output
library(ggfortify) #for model diagnostics
library(sjPlot)    #for outputs
library(knitr)     #for kable
library(effects)   #for partial effects plots
library(emmeans)   #for estimating marginal means
library(MASS)      #for glm.nb
library(MuMIn)     #for AICc
library(tidyverse) #for data wrangling
library(brms)
library(tidybayes)
library(broom.mixed)#for tidying MCMC outputs
library(patchwork)  #for multiple plots
library(rstanarm)
library(ggeffects)
library(bayesplot)
library(rstan)
library(DHARMa)
library(ggridges)
source('C:/Users/amacadam/Dropbox/PhD/Chapter 5- Outplanting/Chapter 5 Scripts/Chapter-5--Outplanting-AGF-corals/helperFunctions.R')
```

# Read in the data
```{r readData, results='markdown', eval=TRUE}
colour <- read.csv("C:/Users/amacadam/Dropbox/PhD/Chapter 2- Physiology/Chapter 2 data/Bayes stats data/physiology/juv_colour2021.csv", header=T, fileEncoding="UTF-8-BOM")
```

```{r}
colour<- colour |>
  mutate( Treatment = factor(Treatment),
          Plate.Slide = factor(Plate.Slide),
          Temp = factor(Temp),
          popcross = factor(popcross),
          Mom = factor(Mom),
          Dad = factor(Dad)) 
```

```{r}
colour<- colour |>
  filter(Timepoint %in% c("0","6")) %>% select(Treatment, Timepoint, Temp,  Family, Colour, IndID, popcross, Tank, Cassette, Plate.Slide, Mom, Dad) |>
  mutate(popcross = factor(popcross)) |>
  pivot_wider(names_from = Timepoint, values_from = Colour) |>
  #filter(substr(T6, 1, 1) != "c") %>%
  #filter(T6 != "NULL") %>% 
  tidyr::unnest() |>
  mutate(Colour = `6` - `0`) |>
  drop_na(Colour)
```

```{r}
colour %>% ggplot(aes(x=popcross, y=Colour, color=Temp)) +
  geom_boxplot() +
  facet_wrap(~Treatment) +
  theme(axis.text.x = element_text(angle = 90))
```

### Using default priors
```{r}
colour.form <- bf(Colour ~ popcross * Temp + (1|Plate.Slide),
                     family = gaussian()
                   )
```

```{r}
options(width=150)
colour.form %>% get_prior(data = colour)
options(width=80)
```

### Defining priors
```{r}
colour |>
group_by(popcross,Temp) |>
summarise(
mean(Colour),
median(Colour),
sd(Colour),
mad(Colour)
)
```

```{r fitModel2h1, results='markdown', eval=TRUE, hidden=TRUE, cache=TRUE}
priors<- prior("normal(1, 0.5)", class = "Intercept") +
    prior("normal(0, 0.5)", class = "b") +
    #prior("normal(0, 0.5)", class = "sd", group = "Tank") +
    prior("normal(0, 0.5)", class = "sd", group = "Plate.Slide") +
    prior(student_t(3, 0, 2), class = 'sigma') +
    prior(cauchy(0,2), class = 'sd')
```

```{r}
colour.brm <- brm(colour.form, 
                  data = colour,
                  prior = priors,
                  sample_prior = 'only',
                  iter = 5000,
                  warmup = 1000,
                  chains = 3,
                  thin = 5,
                  refresh = 0
                  )
```

```{r partialPlot2h1a, results='markdown', eval=TRUE, hidden=TRUE, fig.width=8, fig.height=5}
colour.brm %>%
  conditional_effects() |>
  plot(points = TRUE)
```

```{r fitModel2h1b, results='markdown', eval=TRUE, hidden=TRUE, cache=TRUE}
colour.brm2 <- update(colour.brm,  
                       sample_prior = 'yes',
                       control = list(adapt_delta = 0.99),
                       refresh = 0)
#save(colour.brm2, file = 'colour.brm2')
```

```{r}
colour.brm2 %>%
    conditional_effects() %>%
    plot(points = TRUE)
```

### Plotting prior and posterior
```{r}
colour.brm2 %>% SUYR_prior_and_posterior()
```

```{r}
colour.brm2$fit |> stan_trace()
```

```{r}
colour.brm2$fit |> stan_ac()
```

```{r}
colour.brm2$fit |> stan_rhat()
```

```{r}
colour.brm2$fit |> stan_ess()
```

### Random intercept/slope model
```{r fitModel2h3, results='markdown', eval=TRUE, hidden=TRUE, cache=TRUE}
priors<- prior("normal(1, 0.5)", class = "Intercept") +
    prior("normal(0, 0.5)", class = "b") +
    #prior("normal(0, 0.5)", class = "sd", group = "Tank") +
    prior("normal(0, 0.5)", class = "sd", group = "Plate.Slide") +
    prior(student_t(3, 0, 2), class = 'sigma') +
    prior(cauchy(0,2), class = 'sd') +
    prior(lkj_corr_cholesky(1), class = 'L')
```

```{r}
colour.form <- bf(Colour ~ popcross * Temp + (popcross|Plate.Slide),
                     family = gaussian()
                   )
```

```{r}
colour.brm3 <- brm(colour.form, 
                  data = colour,
                  prior = priors,
                  sample_prior = 'yes',
                  iter = 5000,
                  warmup = 1000,
                  chains = 3,
                  thin = 5,
                  refresh = 0,
                  control = list(adapt_delta = 0.99)
                  )
#save(colour.brm3, file = 'colour.brm3')
```

```{r}
#colour.brm3 %>%
#    conditional_effects() %>%
#    plot(points = TRUE)
```

### Plotting prior and posterior
```{r}
colour.brm3%>% SUYR_prior_and_posterior()
```

```{r}
#colour.brm3$fit |> stan_trace()
```

```{r}
#colour.brm3$fit |> stan_ac()
```

```{r}
#colour.brm3$fit |> stan_rhat()
```

```{r}
#colour.brm3$fit |> stan_ess()
```

### Compare models
```{r fitModel2h3a, results='markdown', eval=TRUE, hidden=TRUE, cache=TRUE}
loo(colour.brm2, colour.brm3)
```

# Model validation
```{r modelValidation5b, results='markdown', eval=TRUE, hidden=TRUE, fig.width=6, fig.height=4}
colour.brm2 %>% pp_check(type = 'dens_overlay', nsamples = 250)
```

```{r modelValidation5c, results='markdown', eval=TRUE, hidden=TRUE, fig.width=6, fig.height=4}
colour.brm2 %>% pp_check(type = 'error_scatter_avg')
```

### DHARMa residuals
```{r}
colour.resids<- make_brms_dharma_res(colour.brm2, integerResponse = FALSE)
wrap_elements(~testUniformity(colour.resids)) +
wrap_elements(~plotResiduals(colour.resids, form = factor(rep(1,nrow(colour))))) +
wrap_elements(~plotResiduals(colour.resids, quantreg = FALSE))+
wrap_elements(~testDispersion(colour.resids))
```

**Conclusions:**
### conditional_effects
```{r partialPlot2d, results='markdown', eval=TRUE, hidden=TRUE, fig.width=8, fig.height=5}
colour.brm2 %>%
    conditional_effects("popcross:Temp") %>%
    plot(points = TRUE)
```

### ggpredict
```{r partialPlot2a, results='markdown', eval=TRUE, hidden=TRUE, fig.width=8, fig.height=5}
colour.brm2 %>%
    ggpredict(~popcross*Temp) %>%
    plot(add.data = TRUE)
```

### ggemmeans
```{r partialPlot2b, results='markdown', eval=TRUE, hidden=TRUE, fig.width=8, fig.height=5}
starling.brm3 %>%
    ggemmeans(~popcross*Temp) %>%
    plot(add.data = TRUE) 
```

```{r}
colour.brm2 |>
  summarise_draws(
    median,
    HDInterval::hdi,
    Pl = ~mean(.x < 0),
    Pg = ~mean(.x > 0),
    rhat,
    ess_bulk
    ) |>
  knitr::kable()
```

```{r}
colour.brm2 |>
  summarise_draws(
    median,
    HDInterval::hdi,
    Pl = ~mean(.x < 0),
    Pg = ~mean(.x > 0),
    rhat,
    ess_bulk
    ) |>
  knitr::kable()
```

```{r summariseModel2c4, results='markdown', eval=TRUE, hidden=TRUE, fig.width=8, fig.height=5,echo=TRUE}
colour.brm2 %>%
    gather_draws(`b_Intercept.*|b_popcross.*|b_Temp.*`, regex=TRUE) %>% 
    ggplot() +
    geom_vline(xintercept=0, linetype='dashed') +
    stat_slab(aes(x = .value, y = .variable,
                  fill = stat(ggdist::cut_cdf_qi(cdf,
                                                 .width = c(0.5, 0.8, 0.95), 
                                                 labels = scales::percent_format())
                              )), color='black') + 
    scale_fill_brewer('Interval', direction = -1, na.translate = FALSE) 
```

```{r}
colour.brm2 %>% 
    gather_draws(`.Intercept.*|b_popcross.*|b_Temp.*`, regex=TRUE) %>% 
    ggplot() + 
    geom_vline(xintercept = 0, linetype='dashed') +
    stat_halfeye(aes(x=.value,  y=.variable)) +
    theme_classic()
```

### density ridges (ggridges)
```{r summariseModel2c7, results='markdown', eval=TRUE, hidden=TRUE, fig.width=8, fig.height=5,echo=TRUE}
##in colour
colour.brm2 %>% 
    gather_draws(`^b_.*`, regex=TRUE) %>% 
    filter(.variable != 'b_Intercept') %>%
    ggplot() + 
    geom_density_ridges_gradient(aes(x=(.value),
                                     y = .variable,
                                     fill = stat(x)),
                                 alpha=0.4, colour = 'white',
                                 quantile_lines = TRUE,
                                 quantiles = c(0.025, 0.975)) +
    geom_vline(xintercept = 1, linetype = 'dashed') +
    scale_x_continuous() +
    scale_fill_viridis_c(option = "C") 

## Fractional scale
colour.brm2 %>% 
    gather_draws(`^b_.*`, regex=TRUE) %>% 
    filter(.variable != 'b_Intercept') %>%
    ggplot() + 
    geom_density_ridges_gradient(aes(x=exp(.value),
                                     y = .variable,
                                     fill = stat(x)),
                                 alpha=0.4, colour = 'white',
                                 quantile_lines = TRUE,
                                 quantiles = c(0.025, 0.975)) +
    geom_vline(xintercept = 1, linetype = 'dashed') +
    scale_x_continuous(trans = scales::log2_trans()) +
    scale_fill_viridis_c(option = "C") 
```
 
### R2
```{r summariseModel2g, results='markdown', eval=TRUE, hidden=TRUE, fig.width=8, fig.height=5}
colour.brm2 %>%
    bayes_R2(re.form = NA, summary=FALSE) %>%
    median_hdci
colour.brm2 %>%
    bayes_R2(re.form = ~(1|Plate.Slide), summary=FALSE) %>%
    median_hdci
colour.brm2 %>%
    bayes_R2(re.form = ~(popcross|Plate.Slide), summary=FALSE) %>%
    median_hdci
```

```{r}
colour.brm2 |>
  emmeans(~popcross, type = "response")
```

planned contrasts- compare situations

                    D1 vs Sed         D1 vs SS        SS vs Sed       Central vs Hybrid       
D1_DAVxDAV      |     -1/10            -1/10                0                   -1/3
 D1_JEWxDAV     |     -1/10             -1/10               0                    1/4
 D1_JEWxJEW     |     -1/10             -1/10               0                    0
 D1_JEWxPAL     |     -1/10             -1/10               0                    1/4
 D1_PALxDAV     |     -1/10             -1/10               0                   -1/3
 D1_PALxPAL     |     -1/10             -1/10               0                   -1/3
 D1_PARxDAV     |     -1/10             -1/10               0                    1/4
 D1_PARxPAR     |     -1/10             -1/10               0                    0
 D1_SWIxDAV     |     -1/10             -1/10               0                    1/4
 D1_SWIxSWI     |     -1/10             -1/10               0                    0
 Jewell_DAVxDAV |      1/10             0                1/10                   -1/3
 Jewell_JEWxDAV |      1/10             0                1/10                    1/4
 Jewell_JEWxJEW |      1/10             0                1/10                    0
 Jewell_JEWxPAL |      1/10             0                1/10                    1/4
 Jewell_PALxDAV |      1/10             0                1/10                   -1/3
 Jewell_PALxPAL |      1/10             0                1/10                   -1/3
 Jewell_PARxDAV |      1/10             0                1/10                    1/4
 Jewell_PARxPAR |      1/10             0                1/10                    0
 Jewell_SWIxDAV |      1/10             0                1/10                    1/4
 Jewell_SWIxSWI |      1/10             0                1/10                    0
 SS_DAVxDAV     |      0             1/10                 -1/10                 -1/3
 SS_JEWxDAV     |      0             1/10                 -1/10                  1/4
 SS_JEWxJEW     |      0             1/10                 -1/10                  0
 SS_JEWxPAL     |      0             1/10                 -1/10                  1/4
 SS_PALxDAV     |      0             1/10                 -1/10                 -1/3
 SS_PALxPAL     |      0             1/10                 -1/10                 -1/3
 SS_PARxDAV     |      0             1/10                 -1/10                  1/4
 SS_PARxPAR     |      0             1/10                 -1/10                  0
 SS_SWIxDAV     |      0             1/10                 -1/10                  1/4
 SS_SWIxSWI     |      0             1/10                 -1/10                  0
 
```{r}
cmat<- cbind("D1 vs Sed"=c(-1/10, -1/10, -1/10, -1/10, -1/10, -1/10, -1/10, -1/10, -1/10, -1/10, 1/10, 1/10, 1/10, 1/10, 1/10, 1/10, 1/10, 1/10, 1/10, 1/10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0),
             "D1 vs SS" = c(-1/10, -1/10, -1/10, -1/10, -1/10, -1/10, -1/10, -1/10, -1/10, -1/10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1/10, 1/10, 1/10, 1/10, 1/10, 1/10, 1/10, 1/10, 1/10, 1/10),
             "SS vs Sed" = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1/10, 1/10, 1/10, 1/10, 1/10, 1/10, 1/10, 1/10, 1/10, 1/10, -1/10, -1/10, -1/10, -1/10, -1/10, -1/10, -1/10, -1/10, -1/10, -1/10),
             "Central vs Hybrid" = c(-1/3, 1/4, 0, 1/4, -1/3, -1/3, 1/4, 0, 1/4, 0, -1/3, 1/4, 0, 1/4, -1/3, -1/3, 1/4, 0, 1/4, 0, -1/3, 1/4, 0, 1/4, -1/3, -1/3, 1/4, 0, 1/4, 0)
             )
```
 
```{r}
colour.brm2 |>
  emmeans(~popcross) |>
  contrast(list(popcross=cmat)) |>
    gather_emmeans_draws() |>
  summarise(median_hdci(.value),
            Pl = mean(.value < 0),
            Pg = mean(.value > 0)
            )
```

```{r}
colour.brm2 |>
  emmeans(~popcross|Temp) |>
  as.data.frame() |>
  ggplot(aes(y = emmean, x = popcross, color = Temp)) +
  geom_pointrange(aes(ymin = lower.HPD, ymax = upper.HPD))
```

#############################################################################################################
Hot only
```{r}
colour.hot<- colour |>
  filter(Temp == "HOT")
```

```{r}
colour.form <- bf(colour ~ popcross + (1|Plate.Slide),
                     family = gaussian()
                   )
```

```{r fitModel2h1, results='markdown', eval=TRUE, hidden=TRUE, cache=TRUE}
priors<- prior("normal(-10, 5)", class = "Intercept") +
    prior("normal(0, 15)", class = "b") +
    prior("normal(0, 7)", class = "sd", group = "Plate.Slide") +
    prior(student_t(2, -5, 1), class = 'sigma') +
    prior(cauchy(0,2.5), class = 'sd')
```

```{r}
colour.brm4 <- brm(colour.form, 
                  data = colour.hot,
                  prior = priors,
                  sample_prior = 'yes',
                  iter = 5000,
                  warmup = 1000,
                  chains = 3,
                  thin = 5,
                  control = list(adapt_delta = 0.99),
                  refresh = 0
                  )
```

```{r partialPlot2h1a, results='markdown', eval=TRUE, hidden=TRUE, fig.width=8, fig.height=5}
colour.brm4 %>%
  conditional_effects() |>
  plot(points = TRUE)
```

### Plotting prior and posterior
```{r}
colour.brm4 %>% SUYR_prior_and_posterior()
```

```{r}
colour.brm4$fit |> stan_trace()
```

```{r}
colour.brm4$fit |> stan_ac()
```

```{r}
colour.brm4$fit |> stan_rhat()
```

```{r}
colour.brm4$fit |> stan_ess()
```

# Model validation
```{r modelValidation5b, results='markdown', eval=TRUE, hidden=TRUE, fig.width=6, fig.height=4}
colour.brm4 %>% pp_check(type = 'dens_overlay', nsamples = 250)
```

### DHARMa residuals
```{r}
colour.resids<- make_brms_dharma_res(colour.brm4, integerResponse = FALSE)
wrap_elements(~testUniformity(colour.resids)) +
wrap_elements(~plotResiduals(colour.resids, form = factor(rep(1,nrow(colour.hot))))) +
wrap_elements(~plotResiduals(colour.resids, quantreg = FALSE))+
wrap_elements(~testDispersion(colour.resids))
```

```{r summariseModel2c4, results='markdown', eval=TRUE, hidden=TRUE, fig.width=8, fig.height=5,echo=TRUE}
colour.brm4 %>%
    gather_draws(`b_Intercept.*|b_popcross.*`, regex=TRUE) %>% 
    ggplot() +
    geom_vline(xintercept=0, linetype='dashed') +
    stat_slab(aes(x = .value, y = .variable,
                  fill = stat(ggdist::cut_cdf_qi(cdf,
                                                 .width = c(0.5, 0.8, 0.95), 
                                                 labels = scales::percent_format())
                              )), color='black') + 
    scale_fill_brewer('Interval', direction = -1, na.translate = FALSE) 
```

####################################################################################################
popcross only
```{r}
colour.form <- bf(colour ~ popcross + (1|Plate.Slide),
                     family = gaussian()
                   )
```

### Defining priors
```{r fitModel2h1, results='markdown', eval=TRUE, hidden=TRUE, cache=TRUE}
priors<- prior("normal(-10, 5)", class = "Intercept") +
    prior("normal(0, 15)", class = "b") +
    #prior("normal(0, 0.5)", class = "sd", group = "Tank") +
    prior("normal(0, 7)", class = "sd", group = "Plate.Slide") +
    prior(student_t(2, -5, 1), class = 'sigma') +
    prior(cauchy(0,2.5), class = 'sd')
```

```{r}
colour.brm5 <- brm(colour.form, 
                  data = colour.hot,
                  prior = priors,
                  sample_prior = 'yes',
                  iter = 5000,
                  warmup = 1000,
                  chains = 3,
                  thin = 5,
                  refresh = 0
                  )
```

```{r partialPlot2h1a, results='markdown', eval=TRUE, hidden=TRUE, fig.width=8, fig.height=5}
colour.brm5 %>%
  conditional_effects() |>
  plot(points = TRUE)
```

```{r summariseModel2c4, results='markdown', eval=TRUE, hidden=TRUE, fig.width=8, fig.height=5,echo=TRUE}
colour.brm5 %>%
    gather_draws(`b_Intercept.*|b_popcross.*`, regex=TRUE) %>% 
    ggplot() +
    geom_vline(xintercept=0, linetype='dashed') +
    stat_slab(aes(x = .value, y = .variable,
                  fill = stat(ggdist::cut_cdf_qi(cdf,
                                                 .width = c(0.5, 0.8, 0.95), 
                                                 labels = scales::percent_format())
                              )), color='black') + 
    scale_fill_brewer('Interval', direction = -1, na.translate = FALSE) 
```