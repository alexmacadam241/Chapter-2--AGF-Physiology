---
title: "Physiology- survival statistics- bayes"
author: "Alex Macadam"
date: "2023-10-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Survival statistics
```{r}
set.seed(123)
library(tidyverse) #for data wrangling
library(car)       #for regression diagnostics
library(broom)     #for tidy output
library(ggfortify) #for model diagnostics
library(sjPlot)    #for outputs
library(knitr)     #for kable
library(effects)   #for partial effects plots
library(emmeans)   #for estimating marginal means
library(MASS)      #for glm.nb
library(MuMIn)     #for AICc
library(brms)
library(broom.mixed)
library(tidybayes)
library(bayesplot)
#library(standist)   #for visualizing distributions
library(rstanarm)
library(ggeffects)
library(rstan)
library(DHARMa)
library(ggridges)
library(easystats)     #framework for stats, modelling and visualisation
library(patchwork)
library(car)       #for regression diagnostics
library(broom)     #for tidy output
library(broom.mixed)
library(ggfortify) #for model diagnostics
#library(sjPlot)    #for outputs
library(knitr)     #for kable
source('/Users/alexmacadam/Dropbox/PhD/Chapter5_Outplanting/Chapter 5 Scripts/Chapter-5--Outplanting-AGF-corals/helperFunctions.R')
```

```{r}
# PERCENT SURVIVAL
# Function for summarising survival standard error
summarySE <- function(data=NULL, measurevar=NULL, groupvars=NULL, na.rm=FALSE,
                      conf.interval=.95, .drop=TRUE) {
  require(plyr)
  
  # New version of length which can handle NA's: if na.rm==T, don't count them
  length2 <- function (x, na.rm=FALSE) {
    if (na.rm==TRUE) sum(!is.na(x))
    else       length(x)
  }
  
  # This does the summary. For each group's data frame, return a vector with
  # N, mean, and sd
  datac <- ddply(data, groupvars, .drop=.drop,
                 .fun = function(xx, col) {
                   c(N    = length2(xx[[col]], na.rm=na.rm),
                     mean = mean   (xx[[col]], na.rm=na.rm),
                     sd   = sd     (xx[[col]], na.rm=na.rm)
                   )
                 },
                 measurevar
  )
  
  # Commenting this rename mean column line, as not assigning measurevar name properly
  # # Rename the "mean" column    
  # datac <- rename(datac, measurevar = mean)
  
  datac$se <- datac$sd / sqrt(datac$N)  # Calculate standard error of the mean
  
  # Confidence interval multiplier for standard error
  # Calculate t-statistic for confidence interval: 
  # e.g., if conf.interval is .95, use .975 (above/below), and use df=N-1
  ciMult <- qt(conf.interval/2 + .5, datac$N-1)
  datac$ci <- datac$se * ciMult
  
  return(datac)
}
```

```{r}
#load data
survival <- read.csv("/Users/alexmacadam/Dropbox/PhD/Chapter2_Physiology/Chapter 2 data/Bayes stats data/survival/larvae_surv2020.csv", header=T, fileEncoding="UTF-8-BOM")
```

```{r}
#change catagorical columns to factors and remove NAs
survival <- survival |>
  mutate(Family = factor(Family),
         Temp = factor(Temp),
         Treatment = factor(Treatment),
         Cone = factor(Cone),
         CrossType = factor(CrossType),
         BoatID = factor(BoatID),
         Cone = factor(Cone),
         Culture = factor(Culture),
         popcross = factor(popcross),
         Region_cross = factor(Region_cross),
         BoatID = factor(BoatID)
         ) |>
  filter(Timepoint == "2", Year==2020, CrossType != 'BulkCross', Species == "A.ten") |> 
  drop_na(No.LarvaeIn)  # drop nas from the start
```

```{r}
surv.summ <- summarySE(survival, measurevar="Percent_Survival_atend",
                     groupvars=c("Temp","popcross"), na.rm=TRUE)

surv_hot<- survival |> dplyr::filter(Region_cross != "NorthxCentral")
surv.hot.summ <- summarySE(survival, measurevar="Percent_Survival_atend",
                     groupvars=c("Temp","Region_cross"), na.rm=TRUE)
```

```{r}
#survival |>
#ggplot(aes(y=Survival, x=Cross2)) +
#    geom_point(position=position_jitter(width=0.2, height=0)) +
#  facet_wrap(~RegionCross)
```

# Fit the model
## Random intercept
form
```{r}
survival.form <- bf(Survival | trials(1) ~ popcross * Temp + (1|BoatID),
                  family=binomial(link='logit'))
```

```{r}
options(width=150)
survival.form %>% get_prior(data = survival)
options(width=80)
```

priors
```{r fitModel2h1, results='markdown', eval=TRUE, mhidden=TRUE, cache=TRUE}
priors <-
    prior(normal(1, 1.5), class = 'Intercept') +
    prior(normal(0, 3), class = 'b') +
    prior(student_t(3, 0, 1.5), class = 'sd') 
```

run model- n
```{r}
#survival.brm2 <- brm(survival.form, 
#                  data = survival,
#                  prior = priors,
#                  sample_prior = 'yes',
#                  iter = 5000,
#                  warmup = 2500,
#                  chains = 3, cores = 3,
#                  thin = 5,
#                  control = list(adapt_delta = 0.99, max_treedepth = 20),
#                  refresh = 100,
#                  backend = "rstan"
#                  )
```

```{r}
#saveRDS(survival.brm2, file = "survival.brm2_A.tenuis_larv.rds")
survival.brm2 <- readRDS("survival.brm2_A.tenuis_larv.rds")
```

rerun model
```{r}
#survival.brm2 <- update(survival.brm,
#                      sample_prior = 'yes',
#                      cores = 3,
#                      refresh = 0)
```

```{r}
survival.brm2 %>% SUYR_prior_and_posterior()
```

```{r}
survival.brm2$fit |> stan_trace()
```

```{r}
survival.brm2$fit |> stan_ac()
```

```{r}
survival.brm2$fit |> stan_rhat()
```

```{r}
survival.brm2$fit |> stan_ess()
```

##Compare models
compare loos
```{r}
#(l.1 <- survival.brm2 %>% loo())
#(l.2 <- survival.brm3 %>% loo())
#loo_compare(l.1, l.2)
loo(survival.brm2, survival.brm3)
#the random intercept only model is lower
```

```{r}
survival.brm2 |> pp_check(type = 'dens_overlay', nsamples = 250)
```

Dharma residuals
```{r}
survival.resids<- make_brms_dharma_res(survival.brm2, integerResponse = FALSE)
wrap_elements(~testUniformity(survival.resids)) +
wrap_elements(~plotResiduals(survival.resids, form = factor(rep(1,nrow(survival))))) +
wrap_elements(~plotResiduals(survival.resids, quantreg = FALSE))+
wrap_elements(~testDispersion(survival.resids))

survival.resids<- make_brms_dharma_res(survival.brm2, integerResponse = FALSE)
testUniformity(survival.resids)
plotResiduals(survival.resids, form = factor(rep(1,nrow(survival))))
plotResiduals(survival.resids, quantreg = FALSE)
testDispersion(survival.resids)
```

Summarise model
```{r}
survival.brm2 |> bayes_R2(re.form = NA)

survival.brm2 |>
  bayes_R2(re.form = NA, summary = FALSE) %>%
  median_hdci()

survival.brm2 |>
  bayes_R2(re.form = ~ (1 | BoatID), summary = FALSE) %>%
  median_hdci()
```

```{r}
survival.brm2 %>%
    conditional_effects() %>%
    plot(points = TRUE)
```

back transform from logit scale: by exponentiating on the odds scale. comparing to 1
```{r}
survival.brm2 |>
  as_draws_df() |>
  mutate(across(everything(), exp)) |>
  summarise_draws(
    median,
    HDInterval::hdi,
    Pl = ~mean(.x < 1),
    Pg = ~mean(.x > 1),
    rhat,
    ess_bulk,
    ess_tail
    ) |>
  knitr::kable()
```

Probability scale
```{r}
survival.brm2 |>
  emmeans(~popcross, type = "response")
```

Planned contrast:

                    Pure vs Hybrid |   PureSouth vs Hybrid  | PureSouth vs Hybrid 2 | PureNorth vs Hybrid | South v North
DaviesxDavies             -1/5            -1/3                     -1/2                     0                  -1/3 
JewellxDavies              1/5             1/4                      1/4                     1/4                 0
JewellxJewell             -1/5             0                        0                      -1/4                 1/3                
JewellxPalms               1/5             1/4                      1/4                     1/4                 0
PalmsxDavies               1/5            -1/3                      0                      -1/4                -1/3
PalmsxPalms               -1/5            -1/3                     -1/2                     0                  -1/3
ParkexDavies               1/5             1/4                      1/4                     1/4                 0
ParkexParke               -1/5             0                        0                      -1/4                 1/3
SwitzerxDavies             1/5             1/4                      1/4                     1/4                 0
SwitzerxSwitzer           -1/5             0                        0                      -1/4                 1/3

```{r}
cmat=cbind(
  "Pure vs Hybrid" = c(-1/5, 1/5, -1/5, 1/5, 1/5, -1/5, 1/5, -1/5, 1/5, -1/5),
  "PureSouth vs Hybrid" = c(-1/3, 1/4, 0, 1/4, -1/3, -1/3, 1/4, 0, 1/4, 0),
  "PureSouth vs Hybrid 2" = c(-1/2, 1/4, 0, 1/4, 0, -1/2, 1/4, 0, 1/4, 0),
  "PureNorth vs Hybrid" = c(0, 1/4, -1/4, 1/4, -1/4, 0, 1/4, -1/4, 1/4, -1/4),
  "South v North" = c(-1/3, 0, 1/3, 0, -1/3, -1/3, 0, 1/3, 0, 1/3),
  "Dav vs DavHyb" = c(-1, 1/3, 0, 0, 0, 0, 1/3, 0, 1/3, 0),
  "Pal vs PalHyb" = c(0, 0, 0, 1, 0, -1, 0, 0, 0, 0),
  "Dav vs JewDav" = c(-1, 1, 0, 0, 0, 0, 0, 0, 0, 0),
  "Pal vs JewPal" = c(0, 0, 0, 1, 0, -1, 0, 0, 0, 0),
  "Dav vs ParDav" = c(-1, 0, 0, 0, 0, 0, 1, 0, 0, 0),
  "Dav vs SwiDav" = c(-1, 0, 0, 0, 0, 0, 0, 0, 1, 0),
  "JewxJew vs JewxDav" = c(0, 1, -1, 0, 0, 0, 0, 0, 0, 0),
  "JewxJew vs JewxPal" = c(0, 0, -1, 1, 0, 0, 0, 0, 0, 0)
)

cmat=cbind(
  "Central vs Hybrid" = c(-1, 1, 0),
  "Central vs North" = c(-1, 0, 1),
  "North vs Hybrid" = c(0, 1, -1)
)
```

```{r}
survival.em <- survival.brm2 |>
  emmeans(~popcross, type = 'response') |>
  contrast(method=list(cmat))
survival.em
```
odds scale:
```{r}
survival.brm2 |>
  emmeans(~popcross, type = 'response') |>
  contrast(method=list(cmat)) |>
  gather_emmeans_draws()
#full contrasts on the link scale
```

```{r}
survival.brm2 %>%
    conditional_effects() %>%
    plot(points = TRUE)
```

```{r}
survival.em<- survival.brm2 |>
  emmeans(~popcross, type = 'response') |>
  contrast(method=list(cmat)) |>
  gather_emmeans_draws() |>
  mutate(across(everything(), exp)) |>
#on odds ratio scale
  dplyr::summarise(median_hdci(.value),
            Pl = mean(.value < 1),
            Pg = mean(.value > 1)
            )
survival.em
```

Including AMB and HOT:
Dav vs DavHyb: Davies hybrids are 53% more likely to survive than pure Davies. strong evidence 0.9460000
Dav vs JewDav: JewellxDavies hybrids are 176% more likely to survive than pure Davies. strong evidence 0.9993333
Dav vs ParDav: ParkexDavies hybrids are NOT more likely to survive than pure Davies.
Dav vs SwiDav: SwitzerxDavies hybrids are 72% more likely to survive than pure Davies. weak evidence 0.8913333
Pal vs PalHyb: Palms hybrid are over 500% more likely to survive than pure Palms. strong evidence 1.0000000
Pure vs Hybrid: hybrids are 52% more likely to survive than pures. strong evidence 0.9806667
PureNorth vs Hybrid: hybrid are 50% more likely to survive than pure norths. evidence 0.9340000
PureSouth vs Hybrid: hybrid are 97% more likely to survive than pure souths. strong evidence 0.9933333
PureSouth vs Hybrid 2: hybrid are 115% more likely to survive than pure souths. strong evidence 1.0000000
South v North: hybrid are 52% more likely to survive than pure. weak evidence 0.8780000

#Plot
get variables
```{r}
survival.brm2 %>% get_variables()
```


```{r}
survival.draw <- survival.brm2 %>%
  gather_draws(`b.Intercept.*|b_popcross.*`, regex = TRUE)
survival.draw
```

```{r}
survival.draw %>% median_hdci()
```

```{r}
survival.draw %>%
  mutate(.value = exp(.value)) %>%
  median_hdci()
```

```{r}
survival.brm2 %>%
  gather_draws(`b_Intercept.*|b_popcross.*`, regex = TRUE) %>%
  ggplot() +
  geom_vline(xintercept = 0, linetype = "dashed") +
  stat_slab(aes(
    x = .value, y = .variable,
    fill = stat(ggdist::cut_cdf_qi(cdf,
      .width = c(0.5, 0.8, 0.95),
      labels = scales::percent_format()
    ))
  ), color = "black") +
  scale_fill_brewer("Interval", direction = -1, na.translate = FALSE)
```

```{r}
## Or in colour
survival.brm2 %>%
  gather_draws(`^b_.*`, regex = TRUE) %>%
  filter(.variable != "b_Intercept") %>%
  ggplot() +
  geom_density_ridges_gradient(aes(
    x = (.value),
    y = .variable,
    fill = stat(x)
  ),
  alpha = 0.4, colour = "white",
  quantile_lines = TRUE,
  quantiles = c(0.025, 0.975)
  ) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  scale_x_continuous() +
  scale_fill_viridis_c(option = "C")
```

```{r}
surv.plot<- survival.brm2 %>%
  emmeans(~popcross) %>%
  gather_emmeans_draws() %>%
    ggplot() +
  #geom_vline(xintercept = 0, linetype = "dashed") +
  stat_slab(aes(
    x = .value, y = popcross,
    fill = stat(ggdist::cut_cdf_qi(cdf,
      .width = c(0.5, 0.8, 0.95),
      labels = scales::percent_format()
    ))
  ), color = "black") +
  scale_fill_brewer("Interval", direction = -1, na.translate = FALSE) +
  theme_classic() +
  labs(x = "Survival", y = "Treatment")
surv.plot
```

#########################################################################
Hot only

filter hot data
```{r}
survival.hot<- survival |>
  filter(Treatment == "Hot")
```

# Fit the model
## Random intercept
form
```{r}
survival.form <- bf(Survival | trials(1) ~ popcross + (1|BoatID),
                  family=binomial(link='logit'))
```

```{r}
options(width=150)
survival.form %>% get_prior(data = survival.hot)
options(width=80)
```

priors
```{r fitModel2h1, results='markdown', eval=TRUE, mhidden=TRUE, cache=TRUE}
priors <-
    prior(normal(0, 1.5), class = 'Intercept') +
    prior(normal(0, 1.5), class = 'b') +
    prior(student_t(3, 0, 1.5), class = 'sd') 
```

run model- n
```{r}
survival.brm4 <- brm(survival.form, 
                  data = survival.hot,
                  prior = priors,
                  sample_prior = 'yes',
                  iter = 5000,
                  warmup = 2500,
                  chains = 3, cores = 3,
                  thin = 5,
                  control = list(adapt_delta = 0.99, max_treedepth = 20),
                  refresh = 0,
                  backend = "rstan"
                  )
```

```{r}
#saveRDS(survival.brm4, file = "survival.brm4_A.tenuis_larv.rds")
survival.brm4 <- readRDS("survival.brm4_A.tenuis_larv.rds")
```

```{r}
survival.brm4 %>% SUYR_prior_and_posterior()
```

```{r}
survival.brm4$fit |> stan_trace()
```

```{r}
survival.brm4$fit |> stan_ac()
```

```{r}
survival.brm4$fit |> stan_rhat()
```

```{r}
survival.brm4$fit |> stan_ess()
```

```{r}
survival.brm4 |> pp_check(type = 'dens_overlay', nsamples = 250)
```

Dharma residuals
```{r}
survival.resids<- make_brms_dharma_res(survival.brm4, integerResponse = FALSE)
wrap_elements(~testUniformity(survival.resids)) +
wrap_elements(~plotResiduals(survival.resids, form = factor(rep(1,nrow(survival))))) +
wrap_elements(~plotResiduals(survival.resids, quantreg = FALSE))+
wrap_elements(~testDispersion(survival.resids))

survival.resids<- make_brms_dharma_res(survival.brm4, integerResponse = FALSE)
testUniformity(survival.resids)
plotResiduals(survival.resids, form = factor(rep(1,nrow(survival.hot))))
plotResiduals(survival.resids, quantreg = FALSE)
testDispersion(survival.resids)
```

Summarise model
conditional effects
```{r}
survival.brm4 %>%
    conditional_effects() %>%
    plot(points = TRUE)
```

back transform from logit scale: by exponentiating on the odds scale. comparing to 1
```{r}
survival.brm4 |>
  as_draws_df() |>
  mutate(across(everything(), exp)) |>
  summarise_draws(
    median,
    HDInterval::hdi,
    Pl = ~mean(.x < 1),
    Pg = ~mean(.x > 1),
    rhat,
    ess_bulk,
    ess_tail
    ) |>
  knitr::kable()
```

Probability scale
```{r}
survival.brm4 |>
  emmeans(~popcross, type = "response")
```

Planned contrast:

                    Pure vs Hybrid |   PureSouth vs Hybrid  | PureSouth vs Hybrid 2 | PureNorth vs Hybrid | South v North
DaviesxDavies             -1/5            -1/3                     -1/2                     0                  -1/3 
JewellxDavies              1/5             1/4                      1/4                     1/4                 0
JewellxJewell             -1/5             0                        0                      -1/4                 1/3                
JewellxPalms               1/5             1/4                      1/4                     1/4                 0
PalmsxDavies               1/5            -1/3                      0                      -1/4                -1/3
PalmsxPalms               -1/5            -1/3                     -1/2                     0                  -1/3
ParkexDavies               1/5             1/4                      1/4                     1/4                 0
ParkexParke               -1/5             0                        0                      -1/4                 1/3
SwitzerxDavies             1/5             1/4                      1/4                     1/4                 0
SwitzerxSwitzer           -1/5             0                        0                      -1/4                 1/3

```{r}
cmat=cbind(
  "Pure vs Hybrid" = c(-1/5, 1/5, -1/5, 1/5, 1/5, -1/5, 1/5, -1/5, 1/5, -1/5),
  "PureSouth vs Hybrid" = c(-1/3, 1/4, 0, 1/4, -1/3, -1/3, 1/4, 0, 1/4, 0),
  "PureSouth vs Hybrid 2" = c(-1/2, 1/4, 0, 1/4, 0, -1/2, 1/4, 0, 1/4, 0),
  "PureNorth vs Hybrid" = c(0, 1/4, -1/4, 1/4, -1/4, 0, 1/4, -1/4, 1/4, -1/4),
  "South v North" = c(-1/3, 0, 1/3, 0, -1/3, -1/3, 0, 1/3, 0, 1/3),
  "Dav vs DavHyb" = c(-1, 1/3, 0, 0, 0, 0, 1/3, 0, 1/3, 0),
  "Pal vs PalHyb" = c(0, 0, 0, 1, 0, -1, 0, 0, 0, 0)
)
```

```{r}
survival.em <- survival.brm4 |>
  emmeans(~popcross, type = 'response') |>
  contrast(method=list(cmat))
survival.em
```
odds scale:
```{r}
survival.brm4 |>
  emmeans(~popcross, type = 'response') |>
  contrast(method=list(cmat)) |>
  gather_emmeans_draws()
#full contrasts on the link scale
```

```{r}
survival.em<- survival.brm4 |>
  emmeans(~popcross, type = 'response') |>
  contrast(method=list(cmat)) |>
  gather_emmeans_draws() |>
  mutate(across(everything(), exp)) |>
#on odds ratio scale
  dplyr::summarise(median_hdci(.value),
            Pl = mean(.value < 1),
            Pg = mean(.value > 1)
            )
survival.em
```
HOT only:
Dav vs DavHyb: NO evidence
Dav vs JewDav: JewellxDavies hybrids are 132% more likely to survive than pure Davies. strong evidence 0.9986666667
Dav vs ParDav: ParkexDavies hybrids are NOT more likely to survive than pure Davies.
Dav vs SwiDav: SwitzerxDavies hybrids are 72% more likely to survive than pure Davies. weak evidence 0.8913333
Pal vs PalHyb: Palms hybrid are over 500% more likely to survive than pure Palms. strong evidence 1.0000000
Pure vs Hybrid: hybrids are 52% more likely to survive than pures. strong evidence 0.9806667
PureNorth vs Hybrid: hybrid are 50% more likely to survive than pure norths. evidence 0.9340000
PureSouth vs Hybrid: hybrid are 97% more likely to survive than pure souths. strong evidence 0.9933333
PureSouth vs Hybrid 2: hybrid are 115% more likely to survive than pure souths. strong evidence 1.0000000
South v North: hybrid are 54% more likely to survive than pure. weak evidence 0.9433333333

#Plot
get variables
```{r}
survival.brm4 %>% get_variables()
```


```{r}
survival.draw <- survival.brm4 %>%
  gather_draws(`b.Intercept.*|b_popcross.*`, regex = TRUE)
survival.draw
```

```{r}
survival.draw %>% median_hdci()
```

```{r}
survival.draw %>%
  mutate(.value = exp(.value)) %>%
  median_hdci()
```

```{r}
survival.brm4 %>%
  gather_draws(`b_Intercept.*|b_popcross.*`, regex = TRUE) %>%
  ggplot() +
  geom_vline(xintercept = 0, linetype = "dashed") +
  stat_slab(aes(
    x = .value, y = .variable,
    fill = stat(ggdist::cut_cdf_qi(cdf,
      .width = c(0.5, 0.8, 0.95),
      labels = scales::percent_format()
    ))
  ), color = "black") +
  scale_fill_brewer("Interval", direction = -1, na.translate = FALSE)
```

```{r}
## Or in colour
survival.brm4 %>%
  gather_draws(`^b_.*`, regex = TRUE) %>%
  filter(.variable != "b_Intercept") %>%
  ggplot() +
  geom_density_ridges_gradient(aes(
    x = (.value),
    y = .variable,
    fill = stat(x)
  ),
  alpha = 0.4, colour = "white",
  quantile_lines = TRUE,
  quantiles = c(0.025, 0.975)
  ) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  scale_x_continuous() +
  scale_fill_viridis_c(option = "C")
```

```{r}
surv.plot<- survival.brm4 %>%
  emmeans(~popcross) %>%
  gather_emmeans_draws() %>%
    ggplot() +
  #geom_vline(xintercept = 0, linetype = "dashed") +
  stat_slab(aes(
    x = .value, y = popcross,
    fill = stat(ggdist::cut_cdf_qi(cdf,
      .width = c(0.5, 0.8, 0.95),
      labels = scales::percent_format()
    ))
  ), color = "black") +
  scale_fill_brewer("Interval", direction = -1, na.translate = FALSE) +
  theme_classic() +
  labs(x = "Survival", y = "Treatment")
surv.plot
```

######
By region cross
# Fit the model
## Random intercept
form
```{r}
survival.form <- bf(Survival | trials(1) ~ Region_cross + (1|BoatID),
                  family=binomial(link='logit'))
```

priors
```{r fitModel2h1, results='markdown', eval=TRUE, mhidden=TRUE, cache=TRUE}
priors <-
    prior(normal(0, 1.5), class = 'Intercept') +
    prior(normal(0, 1.5), class = 'b') +
    prior(student_t(3, 0, 1.5), class = 'sd') 
```

run model- n
```{r}
survival.brm4 <- brm(survival.form, 
                  data = survival.hot,
                  prior = priors,
                  sample_prior = 'yes',
                  iter = 5000,
                  warmup = 2500,
                  chains = 3, cores = 3,
                  thin = 5,
                  control = list(adapt_delta = 0.99, max_treedepth = 20),
                  refresh = 0,
                  backend = "rstan"
                  )
```

```{r}
survival.brm4 %>% SUYR_prior_and_posterior()
```

```{r}
survival.brm4$fit |> stan_trace()
```

```{r}
survival.brm4$fit |> stan_ac()
```

```{r}
survival.brm4$fit |> stan_rhat()
```

```{r}
survival.brm4$fit |> stan_ess()
```

```{r}
survival.brm4 |> pp_check(type = 'dens_overlay', nsamples = 250)
```

Dharma residuals
```{r}
survival.resids<- make_brms_dharma_res(survival.brm4, integerResponse = FALSE)
wrap_elements(~testUniformity(survival.resids)) +
wrap_elements(~plotResiduals(survival.resids, form = factor(rep(1,nrow(survival))))) +
wrap_elements(~plotResiduals(survival.resids, quantreg = FALSE))+
wrap_elements(~testDispersion(survival.resids))

survival.resids<- make_brms_dharma_res(survival.brm4, integerResponse = FALSE)
testUniformity(survival.resids)
plotResiduals(survival.resids, form = factor(rep(1,nrow(survival.hot))))
plotResiduals(survival.resids, quantreg = FALSE)
testDispersion(survival.resids)
```

Summarise model
conditional effects
```{r}
survival.brm4 %>%
    conditional_effects() %>%
    plot(points = TRUE)
```

```{r}
surv.plot<- survival.brm4 %>%
  emmeans(~Region_cross) %>%
  gather_emmeans_draws() %>%
    ggplot() +
  #geom_vline(xintercept = 0, linetype = "dashed") +
  stat_slab(aes(
    x = .value, y = Region_cross,
    fill = stat(ggdist::cut_cdf_qi(cdf,
      .width = c(0.5, 0.8, 0.95),
      labels = scales::percent_format()
    ))
  ), color = "black") +
  scale_fill_brewer("Interval", direction = -1, na.translate = FALSE) +
  theme_classic() +
  labs(x = "Survival", y = "Treatment")
surv.plot
```
