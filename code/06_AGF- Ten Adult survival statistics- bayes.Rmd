---
title: "09_AGF- Adult survival statistics- bayes"
author: "Alex Macadam"
date: "2023-11-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Set working directory
```{r}
setwd("/Users/alexmacadam/Documents/GitHub/Chapter-2--AGF-Physiology/data")
```

Load packages
```{r}
set.seed(123)
library(tidyverse) #for data wrangling
library(car)       #for regression diagnostics
library(broom)     #for tidy output
library(ggfortify) #for model diagnostics
library(sjPlot)    #for outputs
library(knitr)     #for kable
library(effects)   #for partial effects plots
library(emmeans)   #for estimating marginal means
library(MASS)      #for glm.nb
library(MuMIn)     #for AICc
library(brms)
library(broom.mixed)
library(tidybayes)
library(bayesplot)
#library(standist)   #for visualizing distributions
library(rstanarm)
library(ggeffects)
library(rstan)
library(DHARMa)
library(ggridges)
library(easystats)     #framework for stats, modelling and visualisation
library(patchwork)
source('helperFunctions.R')
```

Read in data
```{r}
survival <- read.csv('/Users/alexmacadam/Dropbox/PhD/Chapter2_Physiology/Chapter 2 data/Adults/Yr 1 adult data/Adult-survival-yr1.csv', header=T)
survival <- survival %>% filter(Species != "Hyacinthus") #remove other species data
```

Format columns
```{r}
survival <- survival %>% mutate(Survival=as.numeric(Survival), Bleaching_D=as.numeric(Bleaching_D), TissueArea_cm2=as.numeric(TissueArea_cm2))
```

Change columns to factors
```{r}
survival<- survival %>% mutate(Tank = factor(Tank),
                         Position = factor(Position),
                         Stick = factor(Stick),
                         Genotype = factor(Genotype),
                         Temperature = factor(Temperature),
                         Population = factor(Population),
                         Timepoint = factor(Timepoint),
                         Species = factor(Species)
                        )
```

Filter data timepoints
```{r}
# create vector of included Frag.id's
frags <- survival %>% filter(Timepoint==0) %>% distinct(Frag.id) %>% pull(Frag.id)
survival <- survival %>% filter(Timepoint %in% c(0,3,4) & Frag.id %in% frags)
# can use T3 as base line for data points - if data exists for T3, there will be data for T0, and will be
# valid for T4 (where survival will either be 0 or NA)
finalfrags <- survival %>% filter(Timepoint==3 & !(is.na(Survival))) %>% distinct(Frag.id) %>% pull(Frag.id)
# filter adult survival df to just these frag.id's
survival <- survival %>% filter(Frag.id %in% finalfrags)
# because unique frag.ids have not been assigned across every single frag, (i.e. frags in different treatments
# have the same id), need to do custom filters after the fact...
survival <- survival %>% filter(!(Tank==10 & Temperature==32.5 & Frag.id=='Hya.Dav.12.16')) # data missing for T0 & T3
survival <- survival %>% filter(!(Tank==11 & Temperature==32.5 & Frag.id=='Ten.Dav.12.14'))
```

```{r}
# make temperature treatment, species and population columns factors now before analysis/plotting
survival <- survival %>% mutate(Temperature=factor(Temperature, levels=c('Ambient', 'Hot')),
                            Species=factor(Species, levels=c('Goniastrea','Tenuis')),
                            Population=factor(Population, levels=c('Davies','Jewell','Palms','Parke','Switzer')),
                            Timepoint=factor(Timepoint))
```

```{r}
survival.ten <- survival %>% filter(Species == "Tenuis", Timepoint == "3")
```

```{r}
survival.gon <- survival %>% filter(Species == "Goniastrea", Timepoint == "4")
```

```{r}
# Read in data
survival.hya <- read.csv('/Users/alexmacadam/Dropbox/PhD/Chapter2_Physiology/Chapter 2 data/Adults/Yr 2 adult data/Adult20222_Survivorship.csv', header=T)
survival.hya <- survival.hya %>% filter(Species =="A. hyacinthus")
survival.hya <- survival.hya %>% 
  pivot_longer(cols=c('T0', 'T1', 'T2', 'T3', 'T4', 'T5'), names_to = "Timepoint", values_to = "Survival") %>%
  filter(Survival != "NA")
survival.hya <- survival.hya %>% mutate(Tank = factor(Tank),
                         Position = factor(Position),
                         Stick = factor(Stick),
                         Genotype = factor(Genotype),
                         Temperature = factor(Temp),
                         Population = factor(Reef),
                         Timepoint = factor(Timepoint),
                         Species = factor(Species)
                        )
survival.hya <- survival.hya %>% filter(Timepoint =="T5")
```

```{r}
# make temperature treatment, species and population columns factors now before analysis/plotting
survival.hya <- survival.hya %>% mutate(Temperature=factor(Temp, levels=c('Ambient', 'Hot')),
                            Species=factor(Species),
                            Reef=factor(Reef, levels=c('Davies','Palms','Arlington','Martin','Wood')))
```

```{r}
survival<- plyr::rbind.fill (survival.ten, survival.gon, survival.hya)
glimpse(survival)
```

```{r}
survival |>
ggplot(aes(y=Survival, x=Population)) +
    geom_point(position=position_jitter(width=0.2, height=0)) +
    facet_wrap(~Species)
```

# Fit the model
## Random intercept
form
```{r}
survival.form <- bf(Survival | trials(1) ~ Population * Temperature + (1|Tank),
                  family=binomial(link='logit'))
```

```{r}
options(width=150)
survival.form %>% get_prior(data = survival)
options(width=80)
```

priors
```{r fitModel2h1, results='markdown', eval=TRUE, mhidden=TRUE, cache=TRUE}
priors <-
    prior(normal(0, 2.5), class = 'Intercept') +
    prior(normal(0, 2), class = 'b') +
    prior(student_t(3, 0, 2.5), class = 'sd') 
```


Tenuis
run model
```{r}
survival.brm <- brm(survival.form,
                  data = survival.ten,
                  prior = priors,
                  sample_prior = 'only',
                  iter = 5000,
                  warmup = 2500,
                  chains = 3, cores = 3,
                  thin = 5,
                  control = list(adapt_delta = 0.99, max_treedepth = 20),
                  refresh = 0,
                  backend = "rstan"
                  )
```

conditional effects
```{r}
survival.brm %>%
    conditional_effects() %>%
    plot(points = TRUE)
```

rerun model
```{r}
survival.brm2 <- update(survival.brm,
                      sample_prior = 'yes',
                      cores = 3,
                      refresh = 0)
```

updated conditional effects
```{r}
survival.brm2 %>%
    conditional_effects() %>%
    plot(points = TRUE)
```

```{r}
survival.brm2 %>% SUYR_prior_and_posterior()
```

```{r}
survival.brm2$fit |> stan_trace()
```

```{r}
survival.brm2$fit |> stan_ac()
```

```{r}
survival.brm2$fit |> stan_rhat()
```

```{r}
survival.brm2$fit |> stan_ess()
```

##Random slope model

priors
```{r}
#priors <-
#    prior(normal(0, 1.7), class = 'Intercept') +
#    prior(normal(0, 3), class = 'b') +
#    prior(student_t(3,0,1.7), class = 'sd', coef = "Intercept", group = "Tank") +
#    prior(student_t(3, 0, 1.7), class = 'sd') +
#    prior(lkj_corr_cholesky(1), class = 'cor')
```

form
```{r}
#survival.form <- bf(Survival | trials(1) ~ Population * Temp + Treatment + (Population|Tank),
#                  family=binomial(link='logit'))
```

```{r}
#survival.brm3 <- brm(survival.form, 
#                  data = survival,
#                  prior = priors,
#                  sample_prior = 'yes',
#                  iter = 5000,
#                  warmup = 2500,
#                  chains = 3, cores = 3,
#                  thin = 5,
#                  control = list(adapt_delta = 0.99, max_treedepth = 20),
#                  refresh = 0,
#                  backend = "rstan"
#                  )
```

conditional effects
```{r}
#survival.brm3 %>%
#    conditional_effects() %>%
#    plot(points = TRUE)
```

```{r}
#survival.brm3 %>% SUYR_prior_and_posterior()
```

```{r}
#survival.brm3$fit |> stan_trace()
```

```{r}
#survival.brm3$fit |> stan_ac()
```

```{r}
#survival.brm3$fit |> stan_rhat()
```

```{r}
#survival.brm3$fit |> stan_ess()
```

##Compare models
compare loos
```{r}
#(l.1 <- survival.brm2 %>% loo())
#(l.2 <- survival.brm3 %>% loo())
#loo_compare(l.1, l.2)
#loo(survival.brm2, survival.brm)
```

```{r}
survival.brm2 |> pp_check(type = 'dens_overlay', nsamples = 250)
```

Dharma residuals
```{r}
survival.resids<- make_brms_dharma_res(survival.brm2, integerResponse = FALSE)
wrap_elements(~testUniformity(survival.resids)) +
wrap_elements(~plotResiduals(survival.resids, form = factor(rep(1,nrow(survival))))) +
wrap_elements(~plotResiduals(survival.resids, quantreg = FALSE))+
wrap_elements(~testDispersion(survival.resids))
```

Summarise model
back transform from logit scale: by exponentiating on the odds scale. comparing to 1
```{r}
survival.brm2 |>
  as_draws_df() |>
  mutate(across(everything(), exp)) |>
  summarise_draws(
    median,
    HDInterval::hdi,
    Pl = ~mean(.x < 1),
    Pg = ~mean(.x > 1),
    rhat,
    ess_bulk,
    ess_tail
    ) |>
  knitr::kable()
```

Probability scale
```{r}
survival.brm2 |>
  emmeans(~Population, type = "response")
```

Planned contrast:

Davies
Jewell
Palms
Parke

```{r}
cmat=cbind(
  "South vs North" = c(-1/2, 1/2, -1/2, 1/2)
)
```

```{r}
survival.em <- survival.brm2 |>
  emmeans(~Population, type = 'response') |>
  contrast(method=list(cmat))
survival.em
```
odds scale:
```{r}
survival.brm2 |>
  emmeans(~Population, type = 'response') |>
  contrast(method=list(cmat)) |>
  gather_emmeans_draws()
#full contrasts on the link scale
```

```{r}
survival.em<- survival.brm2 |>
  emmeans(~Population, type = 'response') |>
  contrast(method=list(cmat)) |>
  gather_emmeans_draws() |>
  mutate(across(everything(), exp)) |>
#on odds ratio scale
  summarise(median_hdci(.value),
            Pl = mean(.value < 1),
            Pg = mean(.value > 1)
            )
survival.em
```


#Plot
get variables
```{r}
survival.brm2 %>% get_variables()
```


```{r}
survival.draw <- survival.brm2 %>%
  gather_draws(`b.Intercept.*|b_Population.*`, regex = TRUE)
survival.draw
```

```{r}
survival.draw %>% median_hdci()
```

```{r}
survival.draw %>%
  mutate(.value = exp(.value)) %>%
  median_hdci()
```

```{r}
survival.brm2 %>%
  gather_draws(`b_Intercept.*|b_Population.*`, regex = TRUE) %>%
  ggplot() +
  geom_vline(xintercept = 0, linetype = "dashed") +
  stat_slab(aes(
    x = .value, y = .variable,
    fill = stat(ggdist::cut_cdf_qi(cdf,
      .width = c(0.5, 0.8, 0.95),
      labels = scales::percent_format()
    ))
  ), color = "black") +
  scale_fill_brewer("Interval", direction = -1, na.translate = FALSE)
```

```{r}
survival.brm2 %>%
  gather_draws(`b_Intercept.*|.*:TempHOT$`, regex = TRUE) %>%
  ggplot() +
  geom_vline(xintercept = 0, linetype = "dashed") +
  stat_slab(aes(
    x = .value, y = .variable,
    fill = stat(ggdist::cut_cdf_qi(cdf,
      .width = c(0.5, 0.8, 0.95),
      labels = scales::percent_format()
    ))
  ), color = "black") +
  scale_fill_brewer("Interval", direction = -1, na.translate = FALSE)
```

```{r}
## Or in colour
survival.brm2 %>%
  gather_draws(`^b_.*`, regex = TRUE) %>%
  filter(.variable != "b_Intercept") %>%
  ggplot() +
  geom_density_ridges_gradient(aes(
    x = (.value),
    y = .variable,
    fill = stat(x)
  ),
  alpha = 0.4, colour = "white",
  quantile_lines = TRUE,
  quantiles = c(0.025, 0.975)
  ) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  scale_x_continuous() +
  scale_fill_viridis_c(option = "C")
```

```{r}
## Or in colour
survival.brm2 %>%
  gather_draws(`.*:TempHOT$`, regex = TRUE) %>%
  filter(.variable != "b_Intercept") %>%
  ggplot() +
  geom_density_ridges_gradient(aes(
    x = (.value),
    y = .variable,
    fill = stat(x)
  ),
  alpha = 0.4, colour = "white",
  quantile_lines = TRUE,
  quantiles = c(0.025, 0.975)
  ) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  scale_x_continuous() +
  scale_fill_viridis_c(option = "C")
```

#################################################################
##################################################################
Hot only
```{r}
survival_hot <- survival.ten |>
  filter(Temperature == "Hot")
```

# Fit the model
## Random intercept
form
```{r}
survival.form <- bf(Survival | trials(1) ~ Population + (1|Tank),
                  family=binomial(link='logit'))
```

priors
```{r fitModel2h1, results='markdown', eval=TRUE, mhidden=TRUE, cache=TRUE}
priors <-
    prior(normal(0, 2.5), class = 'Intercept') +
    prior(normal(0, 2), class = 'b') +
    prior(student_t(3, 0, 2.5), class = 'sd') 
```

run model- n
```{r}
survival.brm4 <- brm(survival.form, 
                  data = survival_hot,
                  prior = priors,
                  sample_prior = 'yes',
                  iter = 5000,
                  warmup = 2500,
                  chains = 3, cores = 3,
                  thin = 5,
                  control = list(adapt_delta = 0.99, max_treedepth = 20),
                  refresh = 0,
                  backend = "rstan"
                  )
```

conditional effects
```{r}
#survival.brm %>%
#    conditional_effects() %>%
#    plot(points = TRUE)
```

rerun model
```{r}
#survival.brm4 <- update(survival.brm,
#                      sample_prior = 'yes',
#                      cores = 3,
#                      refresh = 0)
```

updated conditional effects
```{r}
survival.brm4 %>%
    conditional_effects() %>%
    plot(points = TRUE)
```

```{r}
survival.brm4 %>% SUYR_prior_and_posterior()
```

```{r}
survival.brm4$fit |> stan_trace()
```

```{r}
survival.brm4$fit |> stan_ac()
```

```{r}
survival.brm4$fit |> stan_rhat()
```

```{r}
survival.brm4$fit |> stan_ess()
```

```{r}
survival.brm4 |> pp_check(type = 'dens_overlay', nsamples = 250)
```

Dharma residuals
```{r}
survival.resids<- make_brms_dharma_res(survival.brm4, integerResponse = FALSE)
wrap_elements(~testUniformity(survival.resids)) +
wrap_elements(~plotResiduals(survival.resids, form = factor(rep(1,nrow(survival))))) +
wrap_elements(~plotResiduals(survival.resids, quantreg = FALSE))+
wrap_elements(~testDispersion(survival.resids))
```

Summarise model
back transform from logit scale: by exponentiating on the odds scale. comparing to 1
```{r}
survival.brm4 |>
  as_draws_df() |>
  mutate(across(everything(), exp)) |>
  summarise_draws(
    median,
    HDInterval::hdi,
    Pl = ~mean(.x < 1),
    Pg = ~mean(.x > 1),
    rhat,
    ess_bulk,
    ess_tail
    ) |>
  knitr::kable()
```

Probability scale
```{r}
survival.brm4 |>
  emmeans(~Population, type = "response")
```

Planned contrast:

Davies
Jewell
Palms
Parke

```{r}
cmat=cbind(
  "South vs North" = c(-1/2, 1/2, -1/2, 1/2)
)
```

```{r}
survival.em <- survival.brm4 |>
  emmeans(~Population, type = 'response') |>
  contrast(method=list(cmat))
survival.em
```
odds scale:
```{r}
survival.brm4 |>
  emmeans(~Population, type = 'response') |>
  contrast(method=list(cmat)) |>
  gather_emmeans_draws()
#full contrasts on the link scale
```

```{r}
survival.em<- survival.brm4 |>
  emmeans(~Population, type = 'response') |>
  contrast(method=list(cmat)) |>
  gather_emmeans_draws() |>
  mutate(across(everything(), exp)) |>
#on odds ratio scale
  summarise(median_hdci(.value),
            Pl = mean(.value < 1),
            Pg = mean(.value > 1)
            )
survival.em
```

#Plot
get variables
```{r}
survival.brm4 %>% get_variables()
```


```{r}
survival.draw <- survival.brm4 %>%
  gather_draws(`b.Intercept.*|b_Population.*`, regex = TRUE)
survival.draw
```

```{r}
survival.draw %>% median_hdci()
```

```{r}
survival.draw %>%
  mutate(.value = exp(.value)) %>%
  median_hdci()
```

```{r}
survival.brm4 %>%
  gather_draws(`b_Intercept.*|b_Population.*`, regex = TRUE) %>%
  ggplot() +
  geom_vline(xintercept = 0, linetype = "dashed") +
  stat_slab(aes(
    x = .value, y = .variable,
    fill = stat(ggdist::cut_cdf_qi(cdf,
      .width = c(0.5, 0.8, 0.95),
      labels = scales::percent_format()
    ))
  ), color = "black") +
  scale_fill_brewer("Interval", direction = -1, na.translate = FALSE)
```

```{r}
## Or in colour
survival.brm4 %>%
  gather_draws(`^b_.*`, regex = TRUE) %>%
  filter(.variable != "b_Intercept") %>%
  ggplot() +
  geom_density_ridges_gradient(aes(
    x = (.value),
    y = .variable,
    fill = stat(x)
  ),
  alpha = 0.4, colour = "white",
  quantile_lines = TRUE,
  quantiles = c(0.025, 0.975)
  ) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  scale_x_continuous() +
  scale_fill_viridis_c(option = "C")
```
